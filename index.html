<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>事件分割实验 (Event Segmentation Study)</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:'Microsoft YaHei', 'SimHei', Arial, sans-serif;overflow:hidden}
  #videoBox{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center}
  video {
    width: 96%;
    max-height: 96%;
    pointer-events: none !important;
    user-select: none !important;
    cursor: default !important;
  }
  
  /* 提示与计数器 */
  #prompt{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:26px;text-align:center;line-height: 1.5; display:none;}
  #counter{position:fixed;top:20px;right:20px;font-size:24px}
  #help{position:fixed;bottom:20px;left:20px;font-size:14px;color:#ccc}
  #adjustHint{position:fixed;bottom:60px;left:20px;font-size:14px;color:#ccc;display:none}
  
  /* 描述输入框 */
  #descBox{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:20px 30px;border-radius:8px;display:none;z-index:1000;}
  #descBox input{width:350px;font-size:18px;padding:6px 10px}
  #descBox button{margin-left:10px;padding:6px 12px;font-size:16px;cursor: pointer;}
  
  /* 全屏遮罩：同意书 */
  #consent{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:flex;align-items:center;justify-content:center; overflow-y: auto;}
  
  /* 全屏遮罩：完成页 */
  #completion{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;}
  
  /* 选择开始界面 (Starter) */
  #starter {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: #111; z-index: 1500;
      display: none;
      flex-direction: column; align-items: center; justify-content: center;
  }
  #starter select { padding: 10px; font-size: 16px; margin: 10px 0; border-radius: 5px; }
  #starter button { padding: 10px 20px; font-size: 18px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; }

  /* 输入框通用样式 */
  .input-group { margin: 20px 0; }
  .input-group label { display: block; margin-bottom: 8px; font-weight: bold; }
  .input-group input { padding: 10px; width: 100%; box-sizing: border-box; font-size: 16px; }

  /* 倒计时样式 */
  .wait-warning { color: #FF9800; font-size: 20px; margin-bottom: 20px; font-weight: bold;}
  .success-msg { color: #4CAF50; font-size: 20px; margin-bottom: 20px; display: none; }
</style>
</head>
<body>

<!-- 1. 同意书与姓名输入页面 -->
<div id="consent">
  <div style="max-width: 800px; margin: 50px auto; padding: 30px; background: #222; border-radius: 10px; border: 1px solid #444;">
    <h2>事件分割实验 (Event Segmentation Study)</h2>
    <p>在参与实验前，请仔细阅读以下内容：</p>
    <ul>
      <li><strong>任务：</strong> 观看一系列视频，并划分出事件的边界。</li>
      <li><strong>操作：</strong> 当你觉得一个有意义的事件单元结束时，按下空格键暂停，并输入对该事件的简短描述。</li>
      <li><strong>流程：</strong> 首先是 1 个练习视频，随后是 10 个正式实验视频（每个约3分钟）。</li>
    </ul>

    <div style="background:#333;padding:15px;border-radius:5px;margin:20px 0;">
      <h3 style="margin-top:0;">操作说明：</h3>
      <ul style="margin-bottom:0; line-height: 1.6;">
        <li><strong>空格键 (SPACEBAR)</strong> - 暂停/标记边界（再次按空格键可取消暂停，继续播放）</li>
        <li><strong>← → 方向键</strong> - 微调时间点（每次 ±1 秒）</li>
        <li><strong>回车键 (ENTER)</strong> - 确认时间点；<strong>输入描述后，按回车提交</strong></li>
        <li><strong>ESC 键</strong> - 取消本次标记 或 取消输入描述</li>
      </ul>
    </div>

    <div class="input-group">
        <label for="participantName" style="color: #4CAF50;">您的姓名 (Name)：</label>
        <input type="text" id="participantName" placeholder="请输入您的姓名">
    </div>

    <p>点击下方按钮即表示您已理解上述内容并同意参与本实验。</p>
    <button id="agreeBtn" style="padding: 12px 25px; font-size: 18px; background:#4CAF50; color:white; border:none;border-radius:5px;cursor:pointer;">同意并开始 (Agree & Start)</button>
  </div>
</div>

<!-- 2. 章节选择界面 (Starter) -->
<div id="starter">
    <h2>选择开始位置</h2>
    <p style="color:#ccc;">如果您刚才刷新了页面或中途退出，请在下方选择上次中断的视频。</p>
    <label>
        从哪个视频开始：
        <select id="startSelect"></select>
    </label>
    <br>
    <button id="realStartBtn">开始实验</button>
</div>

<!-- 3. 实验主界面 -->
<div id="experiment" style="display: none;">
  <div id="prompt">加载中...</div>
  <div id="counter">事件数: 0</div>
  
  <div id="videoBox">
    <video id="v" controls style="display:none;"></video>
  </div>

  <div id="help">空格=暂停/取消暂停&nbsp;&nbsp; 回车=确认/提交&nbsp;&nbsp; ESC=取消</div>
  <div id="adjustHint">← → 调整时间 (空格=取消暂停) (回车=确认)</div>

  <div id="descBox">
    <label>事件 <span id="evNum"></span> 简述：<br>
      <input id="descInput" type="text" placeholder="例如：主角走出了房间">
    </label>
    <div style="margin-top: 10px;">
      <button id="okBtn">提交 (Submit)</button>
      <button id="cancelBtn" style="margin-left: 10px; background: #666; color:white;">取消 (Cancel)</button>
    </div>
    <div style="font-size: 12px; color: #999; margin-top: 5px;">
        按 回车键 提交  /  按 ESC 键 取消
    </div>
  </div>
</div>

<!-- 4. 完成页面 -->
<div id="completion">
  <h2>感谢您的参与！</h2>
  
  <!-- 倒计时提示 -->
  <div id="waitMsg" class="wait-warning">
      数据正在最终同步，请勿关闭页面... <span id="countdown" style="font-size: 24px; color: white;">5</span>
  </div>
  
  <!-- 成功提示 (默认隐藏) -->
  <div id="finalMsg" class="success-msg">
      ✅ 数据已全部保存，您可以安全关闭窗口了。
  </div>

  <p style="font-size: 14px; color: #ccc; margin-top: 30px;">如有疑问，请联系实验主试。</p>
</div>

<!-- Netlify Form -->
<form id="netlify-data-form" style="display: none;" netlify netlify-honeypot="bot-field" name="event-segmentation-data-cn">
  <input type="hidden" name="form-name" value="event-segmentation-data-cn"> 
  <input type="hidden" name="prolific_pid" id="form-pid">
  <input type="hidden" name="study_id" id="form-study-id">
  <input type="hidden" name="session_id" id="form-session-id">
  <input type="hidden" name="video_index" id="form-video-index">
  <input type="hidden" name="events" id="form-events">
  <input type="hidden" name="completion_time" id="form-time">
  <input type="text" name="bot-field" style="display: none;">
</form>

<script>
// ====== 全局配置 ======
const TOTAL_VIDEOS = 10; 
const STORAGE_KEY_PROGRESS = 'seeg_cn_progress_idx';
const STORAGE_KEY_NAME = 'seeg_cn_participant_name';
// [新增] 用于存储所有历史数据的 Key，解决刷新丢失数据问题
const STORAGE_KEY_ALL_EVENTS = 'seeg_cn_all_accumulated_data';

let participantInfo = {};
let events = []; // 当前视频的事件
let currentIdx = 0; // 0=练习, 1-10=正式

// 页面加载时，尝试自动填充姓名
window.addEventListener('DOMContentLoaded', () => {
    const savedName = localStorage.getItem(STORAGE_KEY_NAME);
    if(savedName) {
        document.getElementById('participantName').value = savedName;
    }
});

// ====== 1. 同意书逻辑 ======
document.getElementById('agreeBtn').addEventListener('click', function() {
    const nameVal = document.getElementById('participantName').value.trim();
    if(!nameVal) {
        alert("请在开始前输入您的姓名。");
        return;
    }
    
    // 保存姓名到本地
    localStorage.setItem(STORAGE_KEY_NAME, nameVal);
    
    // 初始化被试信息
    const timestamp = Date.now();
    participantInfo = {
        PROLIFIC_PID: nameVal, 
        STUDY_ID: 'chinese_exp_v1',
        SESSION_ID: `sess_${timestamp}`
    };
    
    // 隐藏同意书，显示选择界面
    document.getElementById('consent').style.display = 'none';
    showStarterMenu();
});

// ====== 2. 选择开始界面逻辑 ======
function showStarterMenu() {
    const starter = document.getElementById('starter');
    const select = document.getElementById('startSelect');
    
    // 清空旧选项
    select.innerHTML = '';
    
    // 添加选项 0 (练习)
    const opt0 = document.createElement('option');
    opt0.value = 0;
    opt0.textContent = "0. 练习 (Practice)";
    select.appendChild(opt0);
    
    // 添加选项 1-10
    for(let i=1; i<=TOTAL_VIDEOS; i++){
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${i}. 视频 (Video ${i})`;
        select.appendChild(opt);
    }
    
    // 自动选择上次的进度
    const savedIdx = localStorage.getItem(STORAGE_KEY_PROGRESS);
    if(savedIdx !== null) {
        select.value = savedIdx;
    }
    
    starter.style.display = 'flex';
}

document.getElementById('realStartBtn').addEventListener('click', function() {
    const select = document.getElementById('startSelect');
    const selectedVal = parseInt(select.value);
    
    document.getElementById('starter').style.display = 'none';
    document.getElementById('experiment').style.display = 'block';
    
    // 正式开始实验流程
    initializeExperiment(selectedVal);
});

// ====== 3. 实验核心逻辑 ======
function initializeExperiment(startAt) {
    console.log(`Experiment starting at index: ${startAt}`);
    
    currentIdx = startAt;
    let evtCnt = 0; 
    let fineTuning = false;
    let isTransitioning = false; // 防止重复提交跳转

    const v = document.getElementById('v');
    const prompt = document.getElementById('prompt');
    const counter = document.getElementById('counter');
    const descBox = document.getElementById('descBox');
    const descInput = document.getElementById('descInput');
    const evNumSpan = document.getElementById('evNum');
    const adjustHint = document.getElementById('adjustHint');

    loadNext();

    function loadNext(){
        // 重置跳转锁
        isTransitioning = false;

        // 检查是否全部完成
        if(currentIdx > TOTAL_VIDEOS){ 
            finishAll(); 
            return;
        }

        // 保存进度到本地
        localStorage.setItem(STORAGE_KEY_PROGRESS, currentIdx);

        // 设置视频源
        if (currentIdx === 0) {
            v.src = 'practice.mp4';
            prompt.innerHTML = `<span style="color:#4CAF50; font-weight:bold;">[练习阶段 Practice]</span><br><br>这是一个练习视频。<br>准备好后，按任意键开始。`;
        } else {
            v.src = `v${currentIdx}.mp4`;
            if (currentIdx === 1) {
                prompt.innerHTML = `<span style="color:#FF9800; font-weight:bold;">[正式实验开始]</span><br><br>现在开始正式实验（共10个视频）。<br>按任意键播放第一个视频。`;
            } else {
                prompt.innerHTML = `视频 ${currentIdx} / ${TOTAL_VIDEOS}<br>按任意键开始播放。`;
            }
        }
        
        v.style.display = 'none';
        prompt.style.display = 'block';
        
        // [关键] 重置当前视频的事件列表 (但历史数据在 LocalStorage 里是安全的)
        events = []; 
        evtCnt = 0;
        counter.textContent = '事件数: 0';
        fineTuning = false;
    }

    function pauseAndFineTune(){
        if(v.paused && fineTuning){
            fineTuning = false;
            adjustHint.style.display = 'none';
            v.play();
            return;
        }
        v.pause();
        fineTuning = true;
        adjustHint.style.display = 'block';
    }

    function confirmEnd(){
        fineTuning = false;
        adjustHint.style.display = 'none';
        events.push({vid: currentIdx, ev: evtCnt + 1, time: v.currentTime, desc: ''});
        evtCnt++;
        counter.textContent = '事件数: ' + evtCnt;
        descInput.value = '';
        evNumSpan.textContent = evtCnt;
        descBox.style.display = 'block';
        descInput.focus();
    }

    function saveDesc(){
        if(isTransitioning) return;

        const txt = descInput.value.trim();
        if(txt === '') {
            alert('请输入事件描述。');
            descInput.focus();
            return;
        }
        const lastIdx = events.findIndex(o => o.vid === currentIdx && o.ev === evtCnt);
        if(lastIdx > -1) events[lastIdx].desc = txt;
        
        descBox.style.display = 'none';
        
        if(v.ended){
            isTransitioning = true;
            // 提交数据
            saveVideoData(currentIdx);
            
            currentIdx++; 
            setTimeout(() => { loadNext(); }, 300);
        } else {
            v.play();
        }
    }

    function cancelDescription() {
        descBox.style.display = 'none';
        const lastEventIndex = events.findIndex(o => o.vid === currentIdx && o.ev === evtCnt);
        if(lastEventIndex > -1) {
            events.splice(lastEventIndex, 1);
            evtCnt--;
            counter.textContent = '事件数: ' + evtCnt;
        }
        prompt.innerHTML = '已取消本次标记。<br>按任意键继续播放视频...';
        prompt.style.display = 'block';
        v.style.display = 'none';
    }

    function finishAll(){
        document.getElementById('experiment').style.display = 'none';
        document.getElementById('completion').style.display = 'flex';
        
        // 1. 立即触发最终提交
        submitAllDataToNetlify();
        
        // 2. 实验结束，清除进度指针 (但保留数据以防万一)
        localStorage.removeItem(STORAGE_KEY_PROGRESS);

        // 3. 倒计时逻辑
        let timeLeft = 5;
        const countSpan = document.getElementById('countdown');
        const waitMsg = document.getElementById('waitMsg');
        const finalMsg = document.getElementById('finalMsg');
        
        const timer = setInterval(() => {
            timeLeft--;
            countSpan.textContent = timeLeft;
            if(timeLeft <= 0) {
                clearInterval(timer);
                waitMsg.style.display = 'none';
                finalMsg.style.display = 'block';
            }
        }, 1000);
    }

    /* ====== 键盘事件监听 ====== */
    document.getElementById('okBtn').onclick = saveDesc;
    document.getElementById('cancelBtn').onclick = cancelDescription;

    document.onkeydown = (e) => {
        if(document.getElementById('experiment').style.display === 'none') return;

        if(document.activeElement.id === 'descInput') {
            if(e.code === 'Enter'){ e.preventDefault(); saveDesc(); }
            if(e.code === 'Escape') { e.preventDefault(); cancelDescription(); }
            return;
        }

        if(v.style.display === 'none' && prompt.style.display !== 'none' && e.target.tagName !== 'INPUT'){
            prompt.style.display = 'none';
            v.style.display = 'block';
            v.play();
            return;
        }

        if(v.style.display !== 'none'){
            if(e.code === 'Space'){ e.preventDefault(); pauseAndFineTune(); return; }
            if(fineTuning && v.paused){
                if(e.code === 'ArrowLeft' || e.code === 'ArrowRight'){
                    e.preventDefault();
                    const step = e.code === 'ArrowLeft' ? -1 : 1;
                    v.currentTime = Math.max(0, v.currentTime + step);
                    return;
                }
                if(e.code === 'Enter'){ e.preventDefault(); confirmEnd(); return; }
            }
        }
    };

    v.onended = () => {
        const finalTime = v.duration; 
        events.push({vid: currentIdx, ev: evtCnt + 1, time: finalTime, desc: '[auto-end]'});
        evtCnt++;
        counter.textContent = '事件数: ' + evtCnt;
        descInput.value = '';
        evNumSpan.textContent = evtCnt;
        descBox.style.display = 'block';
        descInput.focus();
    };
}

// ====== 4. 数据提交逻辑 (核心修改) ======

// 辅助函数：将当前视频数据合并到 LocalStorage 的总历史记录中
function appendToLocalStorage(newEvents) {
    let allData = [];
    try {
        const stored = localStorage.getItem(STORAGE_KEY_ALL_EVENTS);
        if (stored) allData = JSON.parse(stored);
    } catch (e) { allData = []; }

    // 将新数据追加进去 (简单追加，不去重，方便后续分析清洗)
    allData = allData.concat(newEvents);
    
    localStorage.setItem(STORAGE_KEY_ALL_EVENTS, JSON.stringify(allData));
    return allData;
}

async function saveVideoData(videoIndex) {
    const vIndexStr = (videoIndex === 0) ? "practice" : videoIndex.toString();
    const videoEvents = events.filter(o => o.vid === videoIndex);
    
    // [重要] 第一步：先保存到本地硬盘 (防止刷新丢失)
    appendToLocalStorage(videoEvents);

    // 第二步：尝试发送给 Netlify (每个视频一次)
    const formData = new FormData();
    formData.append('form-name', 'event-segmentation-data-cn');
    formData.append('prolific_pid', participantInfo.PROLIFIC_PID);
    formData.append('study_id', participantInfo.STUDY_ID);
    formData.append('session_id', participantInfo.SESSION_ID);
    formData.append('video_index', vIndexStr);
    formData.append('events', JSON.stringify(videoEvents));
    formData.append('completion_time', new Date().toISOString());
    formData.append('bot-field', '');

    try {
        await fetch('/', { method: 'POST', body: formData });
        console.log(`✅ 视频 ${vIndexStr} 数据已保存 (Netlify)。`);
    } catch (error) {
        console.error(`❌ 保存视频 ${vIndexStr} 时出错:`, error);
    }
}

async function submitAllDataToNetlify() {
    // [核心修改] 这里不再提交当前的 events 变量
    // 而是从 LocalStorage 读取我们在整个实验过程中积累的所有数据
    let allAccumulatedData = [];
    try {
        const stored = localStorage.getItem(STORAGE_KEY_ALL_EVENTS);
        if (stored) allAccumulatedData = JSON.parse(stored);
    } catch (e) { }

    // 如果没有数据 (极少见)，就用当前的 events
    if (!allAccumulatedData || allAccumulatedData.length === 0) {
        allAccumulatedData = events;
    }

    console.log("正在提交最终汇总数据:", allAccumulatedData);

    const formData = new FormData(document.getElementById('netlify-data-form'));
    document.getElementById('form-pid').value = participantInfo.PROLIFIC_PID;
    document.getElementById('form-video-index').value = 'all_completed_accumulated'; // 标记这是汇总数据
    document.getElementById('form-events').value = JSON.stringify(allAccumulatedData); // 提交累积数据
    document.getElementById('form-time').value = new Date().toISOString();
    
    try {
        await fetch('/', { method: 'POST', body: formData });
        console.log("✅ 最终汇总数据提交成功！");
    } catch (error) {
        console.log("⚠️ 最终提交可能因网络原因变慢或失败，但单次数据应已保存。");
    }
}
</script>
</body>
</html>
