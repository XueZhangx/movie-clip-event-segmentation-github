<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Segmentation Study</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
#videoBox{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center}
video {
    width: 100%;
    height: 100%;
    max-width: 100vw;
    max-height: 100vh;
    object-fit: contain;
    pointer-events: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
    user-select: none !important;
    cursor: default !important;
}
#prompt{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:26px;text-align:center;line-height:1.5;white-space:pre-line;}
#counter{position:fixed;top:20px;right:20px;font-size:24px}
#help{position:fixed;bottom:20px;left:20px;font-size:14px;color:#ccc;line-height:1.4;}
#adjustHint{position:fixed;bottom:60px;left:20px;font-size:14px;color:#ccc;display:none;line-height:1.4;}
#descBox{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:20px 30px;border-radius:8px;display:none;z-index:1000;}
#descBox input{width:350px;font-size:18px;padding:6px 10px}
#descBox button{margin-left:10px;padding:6px 12px;font-size:16px}
#consent{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:flex;align-items:center;justify-content:center;}
#completion{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;}
#starter{position:fixed;top:20px;left:20px;z-index:999;background:#222;padding:15px;border-radius:8px;border:1px solid #444;}
</style>
</head>
<body>
<!-- 同意书页面 -->
<div id="consent">
    <div style="max-width: 800px; margin: 50px auto; padding: 30px; background: #222; border-radius: 10px; border: 1px solid #444;">
        <h2>Research Study: Event Segmentation in Videos</h2>
        <p>Please read the following information carefully before proceeding:</p>
        <ul>
            <li><strong>Task:</strong> You will watch 10 short video clips (about 3 minutes each)</li>
            <li><strong>Your Role:</strong> Mark significant event boundaries by pressing the SPACEBAR when you feel one meaningful unit ends and another begins</li>
            <li><strong>Process:</strong> After each marked event, you'll provide a brief description of what just happened</li>
            <li><strong>Duration:</strong> The study will take approximately 30-40 minutes to complete</li>
            <li><strong>Data:</strong> Your responses will be recorded anonymously for research purposes</li>
            <li><strong>Voluntary:</strong> You may withdraw at any time without penalty</li>
        </ul>
        
        <div style="background:#333;padding:15px;border-radius:5px;margin:20px 0;">
            <h3 style="margin-top:0;">How to Mark Events:</h3>
            <ul style="margin-bottom:0;">
                <li><strong>SPACEBAR</strong> - Mark an event boundary (pause video)</li>
                <li><strong>← → ARROWS</strong> - Fine-tune the timing (±1 second)</li>
                <li><strong>ENTER</strong> - Confirm this event boundary</li>
                <li><strong>SPACEBAR again</strong> - Cancel and resume playback</li>
                <li><strong>ESC</strong> - Cancel event marking</li>
            </ul>
        </div>
        
        <p>By clicking "I Agree to Participate", you indicate that you understand these instructions and consent to participate in this research study.</p>
        <button id="agreeBtn" style="padding: 12px 25px; font-size: 18px; background:#4CAF50;border:none;border-radius:5px;cursor:pointer;">I Agree to Participate</button>
    </div>
</div>

<!-- 实验界面 -->
<div id="experiment" style="display: none;">
    <div id="starter">
        <div style="margin-bottom:10px;font-size:14px;color:#ccc;">If you need to restart or continue:</div>
        <label style="font-size:14px;">Start from video:
            <select id="startSelect" style="margin-left:5px;"></select>
        </label>
        <div style="margin-top:10px;">
            <button id="startBtn" style="padding:5px 10px;">Start New Session</button>
            <button id="continueBtn" style="display:none;padding:5px 10px;margin-left:5px;">Continue</button>
        </div>
    </div>

    <div id="prompt">Click "Start New Session" above to begin</div>
    <div id="counter">Events: 0</div>
    <div id="videoBox">
        <video id="v" controls style="display:none;"></video>
    </div>
    <div id="help">
        <div>SPACEBAR = Mark event boundary (pause video)</div>
        <div>← → = Adjust timing (±1 second) | ENTER = Confirm boundary</div>
    </div>
    <div id="adjustHint">
        <div>Adjusting: Use ← → to fine-tune the time point</div>
        <div>Press ENTER to confirm, or SPACEBAR to cancel and resume</div>
    </div>

    <div id="descBox">
        <label>Please describe what happened at this event boundary:<br>
            <input id="descInput" type="text" placeholder="Example: The main character decided to leave the building...">
        </label>
        <div style="margin-top: 15px;">
            <button id="okBtn" style="background:#4CAF50;border:none;padding:8px 16px;border-radius:4px;">Submit Description (ENTER)</button>
            <button id="cancelBtn" style="margin-left: 10px; background: #666;border:none;padding:8px 16px;border-radius:4px;">Cancel Event (ESC)</button>
        </div>
        <div style="font-size: 12px; color: #999; margin-top: 8px;">
            Description cannot be empty. Press ENTER to submit or ESC to cancel.
        </div>
    </div>
</div>

<!-- 完成页面 -->
<div id="completion">
    <h2>Thank You for Your Participation!</h2>
    <p style="font-size: 18px; margin: 20px 0;">Your data has been successfully recorded.</p>
    <p style="font-size: 16px; margin: 10px 0;">Completion Code: <strong style="color: #4CAF50; font-size: 20px;">SEGMENT2024</strong></p>
    <p style="font-size: 14px; color: #ccc; margin-top: 30px;">You will be redirected back to Prolific shortly...</p>
</div>

<!-- Netlify数据收集表单（隐藏） -->
<form id="netlify-data-form" style="display: none;" netlify netlify-honeypot="bot-field" name="event-segmentation-data">
    <input type="hidden" name="prolific_pid" id="form-pid">
    <input type="hidden" name="study_id" id="form-study-id">
    <input type="hidden" name="session_id" id="form-session-id">
    <input type="hidden" name="video_index" id="form-video-index">
    <input type="hidden" name="events" id="form-events">
    <input type="hidden" name="completion_time" id="form-time">
    <input type="text" name="bot-field" style="display: none;">
</form>

<script>
// ====== PAVLOVIA 和 PROLIFIC 集成 ======

// 从URL获取Prolific参数
function getProlificParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
        PROLIFIC_PID: urlParams.get('PROLIFIC_PID') || 'test_participant',
        STUDY_ID: urlParams.get('STUDY_ID') || 'test_study', 
        SESSION_ID: urlParams.get('SESSION_ID') || 'test_session'
    };
}

// 获取Prolific信息
const prolificInfo = getProlificParameters();

// 重定向回Prolific
function redirectToProlific() {
    const completionCode = 'SEGMENT2024';
    const prolificURL = `https://app.prolific.co/submissions/complete?cc=${completionCode}`;
    
    setTimeout(() => {
        window.location.href = prolificURL;
    }, 3000);
}

// 提交单个视频数据到Netlify Forms
async function saveVideoData(videoIndex) {
    const videoEvents = events.filter(o => o.vid === videoIndex);
    
    const dataToSend = {
        prolific_pid: prolificInfo.PROLIFIC_PID,
        study_id: prolificInfo.STUDY_ID,
        session_id: prolificInfo.SESSION_ID,
        video_index: videoIndex,
        events: JSON.stringify(videoEvents),
        completion_time: new Date().toISOString()
    };

    // 填充隐藏表单
    document.getElementById('form-pid').value = dataToSend.prolific_pid;
    document.getElementById('form-study-id').value = dataToSend.study_id;
    document.getElementById('form-session-id').value = dataToSend.session_id;
    document.getElementById('form-video-index').value = dataToSend.video_index;
    document.getElementById('form-events').value = dataToSend.events;
    document.getElementById('form-time').value = dataToSend.completion_time;

    try {
        const form = document.getElementById('netlify-data-form');
        const formData = new FormData(form);
        
        // 静默提交到Netlify（用户无感知）
        await fetch('/', {
            method: 'POST',
            body: formData
        });
        console.log(`Video ${videoIndex} data successfully submitted to Netlify Forms`);
    } catch (error) {
        console.log(`Video ${videoIndex} data submission completed`);
    }
}

// 提交所有数据到Netlify Forms（实验结束时）
async function submitAllDataToNetlify() {
    const dataToSend = {
        prolific_pid: prolificInfo.PROLIFIC_PID,
        study_id: prolificInfo.STUDY_ID,
        session_id: prolificInfo.SESSION_ID,
        all_events: JSON.stringify(events),
        completion_time: new Date().toISOString(),
        status: 'completed'
    };

    // 填充隐藏表单
    document.getElementById('form-pid').value = dataToSend.prolific_pid;
    document.getElementById('form-study-id').value = dataToSend.study_id;
    document.getElementById('form-session-id').value = dataToSend.session_id;
    document.getElementById('form-video-index').value = 'all';
    document.getElementById('form-events').value = dataToSend.all_events;
    document.getElementById('form-time').value = dataToSend.completion_time;

    try {
        const form = document.getElementById('netlify-data-form');
        const formData = new FormData(form);
        
        await fetch('/', {
            method: 'POST',
            body: formData
        });
        console.log('All data successfully submitted to Netlify Forms');
    } catch (error) {
        console.log('Final data submission completed');
    }
}

// ====== 实验主要逻辑 ======
const TOTAL = 10;
const FRAME_DUR = 1.0;
const STORAGE_KEY = 'seeg_lastVideo';

// 显示同意书
document.getElementById('consent').style.display = 'flex';
document.getElementById('agreeBtn').addEventListener('click', function() {
    document.getElementById('consent').style.display = 'none';
    document.getElementById('experiment').style.display = 'block';
    initializeExperiment();
});

function initializeExperiment() {
    // 记录实验开始
    console.log('Experiment started for participant:', prolificInfo.PROLIFIC_PID);

    /* ====== 序号选择器 + 按钮初始化 ====== */
    const startSelect = document.getElementById('startSelect');
    const startBtn = document.getElementById('startBtn');
    const continueBtn = document.getElementById('continueBtn');

    // 生成 1-10 选项
    for(let i = 1; i <= TOTAL; i++){
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        startSelect.appendChild(opt);
    }

    // 初始值：URL 参数 > 存储 > 1
    const urlParams = new URLSearchParams(location.search);
    let startIdx = parseInt(urlParams.get('start')) || 0;
    if(!startIdx || startIdx < 1 || startIdx > TOTAL) startIdx = parseInt(localStorage.getItem(STORAGE_KEY)) || 1;
    startSelect.value = startIdx;

    // 按钮事件
    startBtn.addEventListener('click', () => {
        startExperiment(parseInt(startSelect.value));
    });

    continueBtn.addEventListener('click', () => {
        startExperiment(parseInt(localStorage.getItem(STORAGE_KEY)) || 1);
    });

    // 有断点且非 URL 指定 → 显示「继续」按钮
    if(!urlParams.has('start') && localStorage.getItem(STORAGE_KEY)){
        continueBtn.style.display = 'inline';
        prompt.textContent = 'Click "Continue" to resume, or "Start New Session" to begin from a different video';
    }

    /* ====== 主要变量和函数 ====== */
    let idx = startIdx, events = [], evtCnt = 0, fineTuning = false;
    const v = document.getElementById('v');
    const prompt = document.getElementById('prompt');
    const counter = document.getElementById('counter');
    const descBox = document.getElementById('descBox');
    const descInput = document.getElementById('descInput');
    const evNumSpan = document.getElementById('evNum');
    const adjustHint = document.getElementById('adjustHint');

    // 统一的开始函数
    function startExperiment(startIndex) {
        idx = startIndex;
        events = [];
        localStorage.setItem(STORAGE_KEY, idx);
        document.getElementById('starter').style.display = 'none';
        loadNext();
    }

    function saveProgress(n){ 
        localStorage.setItem(STORAGE_KEY, n); 
    }

    function loadNext(){
        if(idx > TOTAL){ 
            finishAll(); 
            return;
        }
        
        saveProgress(idx);
        v.src = `v${idx}.mp4`;
        v.style.display = 'none';
        
        prompt.textContent = `Ready for Video ${idx} of ${TOTAL}\n\nPress any key to start playing`;
        prompt.style.display = 'block';
        evtCnt = 0;
        counter.textContent = 'Events: 0';
        fineTuning = false;
    }

    function pauseAndFineTune(){
        if(v.paused && fineTuning){
            // 第二次按空格：取消微调，恢复播放
            fineTuning = false;
            adjustHint.style.display = 'none';
            v.play();
            return;
        }
        // 第一次按空格：暂停并进入微调模式
        v.pause();
        fineTuning = true;
        adjustHint.style.display = 'block';
    }

    function confirmEnd(){
        fineTuning = false;
        adjustHint.style.display = 'none';
        events.push({vid: idx, ev: evtCnt + 1, time: v.currentTime, desc: ''});
        evtCnt++;
        counter.textContent = 'Events: ' + evtCnt;
        descInput.value = '';
        evNumSpan.textContent = evtCnt;
        descBox.style.display = 'block';
        descInput.focus();
    }

    function saveDesc(){
        const txt = descInput.value.trim();
        // 非空检查
        if(txt === '') {
            alert('Please enter a description for this event.');
            descInput.focus();
            return;
        }

        const lastIdx = events.findIndex(o => o.vid === idx && o.ev === evtCnt);
        if(lastIdx > -1) events[lastIdx].desc = txt;
        descBox.style.display = 'none';
        
        if(v.ended){
            // 保存当前视频数据
            saveVideoData(idx);
            
            idx++;
            
            if(idx <= TOTAL){
                setTimeout(() => {
                    loadNext();
                }, 300);
            } else {
                finishAll();
            }
        } else {
            v.play();
        }
    }

    function finishAll(){
        // 提交所有数据到Netlify（作为备份）
        submitAllDataToNetlify();
        
        // 显示完成页面
        document.getElementById('experiment').style.display = 'none';
        document.getElementById('completion').style.display = 'flex';
        localStorage.removeItem(STORAGE_KEY);
        
        // 重定向回Prolific
        redirectToProlific();
    }

    // 添加取消函数
    function cancelDescription() {
        descBox.style.display = 'none';
        
        // 完全移除刚才添加的未描述事件
        const lastEventIndex = events.findIndex(o => o.vid === idx && o.ev === evtCnt);
        if(lastEventIndex > -1) {
            events.splice(lastEventIndex, 1);
            evtCnt--;
            counter.textContent = 'Events: ' + evtCnt;
        }
        
        // 直接恢复播放，不显示提示
        v.play();
    }

    /* ====== 事件监听器 ====== */
    document.getElementById('okBtn').addEventListener('click', function() {
        if(descInput.value.trim() === '') {
            alert('Please enter a description before submitting.');
            return;
        }
        saveDesc();
    });

    document.getElementById('cancelBtn').addEventListener('click', cancelDescription);

    document.addEventListener('keydown', (e) => {
        if(document.activeElement.id === 'descInput') {
            if(e.code === 'Enter'){
                e.preventDefault();
                if(descInput.value.trim() === '') {
                    alert('Please enter a description before submitting.');
                    return;
                }
                saveDesc();
            }
            if(e.code === 'Escape') {
                e.preventDefault();
                cancelDescription();
            }
            return;
        }
        
        // 阻止在starter显示时按任意键开始视频
        if(document.getElementById('starter').style.display !== 'none') {
            return;
        }
        
        if(e.code === 'Space' && v.style.display !== 'none'){
            e.preventDefault();
            pauseAndFineTune();
            return;
        }
        
        if(fineTuning && v.paused && (e.code === 'ArrowLeft' || e.code === 'ArrowRight')){
            e.preventDefault();
            const step = e.code === 'ArrowLeft' ? -1 : 1;
            v.currentTime = Math.max(0, v.currentTime + step);
            return;
        }
        
        if(fineTuning && v.paused && e.code === 'Enter'){
            e.preventDefault();
            confirmEnd();
            return;
        }
        
        if(v.style.display === 'none' && prompt.style.display !== 'none' && e.target.tagName !== 'INPUT'){
            prompt.style.display = 'none';
            v.style.display = 'block';
            v.play();
        }
    });

    v.addEventListener('ended', () => {
        if(v.currentTime < 1) return;
        events.push({vid: idx, ev: evtCnt + 1, time: 180.00, desc: '[auto-end]'});
        evtCnt++;
        counter.textContent = 'Events: ' + evtCnt;
        descInput.value = '';
        evNumSpan.textContent = evtCnt;
        descBox.style.display = 'block';
        descInput.focus();
    });
}
</script>
</body>
</html>