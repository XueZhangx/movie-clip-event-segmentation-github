<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>事件分割实验 (Event Segmentation Study)</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:'Microsoft YaHei', 'SimHei', Arial, sans-serif;overflow:hidden}
  #videoBox{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center}
  video {
    width: 96%;
    max-height: 96%;
    pointer-events: none !important;
    user-select: none !important;
    cursor: default !important;
  }
  
  /* 提示与计数器 */
  #prompt{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:26px;text-align:center;line-height: 1.5; display:none;}
  #counter{position:fixed;top:20px;right:20px;font-size:24px}
  #help{position:fixed;bottom:20px;left:20px;font-size:14px;color:#ccc}
  #adjustHint{position:fixed;bottom:60px;left:20px;font-size:14px;color:#ccc;display:none}
  
  /* 描述输入框 */
  #descBox{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:20px 30px;border-radius:8px;display:none;z-index:1000;}
  #descBox input{width:350px;font-size:18px;padding:6px 10px}
  #descBox button{margin-left:10px;padding:6px 12px;font-size:16px;cursor: pointer;}
  
  /* 全屏遮罩：同意书 */
  #consent{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:flex;align-items:center;justify-content:center; overflow-y: auto;}
  
  /* 全屏遮罩：完成页 */
  #completion{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;}
  
  /* 选择开始界面 (Starter) */
  #starter {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: #111; z-index: 1500;
      display: none;
      flex-direction: column; align-items: center; justify-content: center;
  }
  #starter select { padding: 10px; font-size: 16px; margin: 10px 0; border-radius: 5px; }
  #starter button { padding: 10px 20px; font-size: 18px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; }

  .input-group { margin: 20px 0; }
  .input-group label { display: block; margin-bottom: 8px; font-weight: bold; }
  .input-group input { padding: 10px; width: 100%; box-sizing: border-box; font-size: 16px; }
  
  /* 倒计时样式 */
  .wait-warning { color: #FF9800; font-size: 20px; margin-bottom: 20px; font-weight: bold;}
  .success-msg { color: #4CAF50; font-size: 20px; margin-bottom: 20px; display: none; }
</style>
</head>
<body>

<!-- 1. 同意书 -->
<div id="consent">
  <div style="max-width: 800px; margin: 50px auto; padding: 30px; background: #222; border-radius: 10px; border: 1px solid #444;">
    <h2>事件分割实验 (Event Segmentation Study)</h2>
    <p>在参与实验前，请仔细阅读以下内容：</p>
    <ul>
      <li><strong>任务：</strong> 观看一系列视频，并划分出事件的边界。</li>
      <li><strong>操作：</strong> 当你觉得一个有意义的事件单元结束时，按下空格键暂停，并输入对该事件的简短描述。</li>
      <li><strong>流程：</strong> 首先是 1 个练习视频，随后是 10 个正式实验视频。</li>
    </ul>

    <div style="background:#333;padding:15px;border-radius:5px;margin:20px 0;">
      <h3 style="margin-top:0;">操作说明：</h3>
      <ul style="margin-bottom:0; line-height: 1.6;">
        <li><strong>空格键 (SPACEBAR)</strong> - 暂停/标记边界（再次按空格键可取消暂停，继续播放）</li>
        <li><strong>← → 方向键</strong> - 微调时间点（每次 ±1 秒）</li>
        <li><strong>回车键 (ENTER)</strong> - 确认时间点；<strong>输入描述后，按回车提交</strong></li>
        <li><strong>ESC 键</strong> - 取消本次标记 或 取消输入描述</li>
      </ul>
    </div>

    <div class="input-group">
        <label for="participantName" style="color: #4CAF50;">您的姓名 (Name)：</label>
        <input type="text" id="participantName" placeholder="请输入您的姓名">
    </div>

    <button id="agreeBtn" style="padding: 12px 25px; font-size: 18px; background:#4CAF50; color:white; border:none;border-radius:5px;cursor:pointer;">同意并开始</button>
  </div>
</div>

<!-- 2. 开始选择 -->
<div id="starter">
    <h2>选择开始位置</h2>
    <p style="color:#ccc;">如果您刚才刷新了页面或中途退出，请在下方选择上次中断的视频。</p>
    <label>
        从哪个视频开始：
        <select id="startSelect"></select>
    </label>
    <br>
    <button id="realStartBtn">开始实验</button>
</div>

<!-- 3. 实验界面 -->
<div id="experiment" style="display: none;">
  <div id="prompt">加载中...</div>
  <div id="counter">事件数: 0</div>
  <div id="videoBox">
    <video id="v" controls style="display:none;"></video>
  </div>
  <div id="help">空格=暂停/取消暂停&nbsp;&nbsp; 回车=确认/提交&nbsp;&nbsp; ESC=取消</div>
  <div id="adjustHint">← → 调整时间 (空格=取消暂停) (回车=确认)</div>
  <div id="descBox">
    <label>事件 <span id="evNum"></span> 简述：<br>
      <input id="descInput" type="text" placeholder="例如：主角走出了房间">
    </label>
    <div style="margin-top: 10px;">
      <button id="okBtn">提交 (Submit)</button>
      <button id="cancelBtn" style="margin-left: 10px; background: #666; color:white;">取消 (Cancel)</button>
    </div>
    <div style="font-size: 12px; color: #999; margin-top: 5px;">
        按 回车键 提交  /  按 ESC 键 取消
    </div>
  </div>
</div>

<!-- 4. 完成页 -->
<div id="completion">
  <h2>感谢您的参与！</h2>
  <div id="waitMsg" class="wait-warning">
      数据正在最终同步，请勿关闭页面... <span id="countdown" style="font-size: 24px; color: white;">5</span>
  </div>
  <div id="finalMsg" class="success-msg">
      ✅ 数据已全部保存，您可以安全关闭窗口了。
  </div>
</div>

<!-- Netlify Form (HIDDEN) - 关键：保持你原始代码的 Form 结构 -->
<form id="netlify-data-form" style="display: none;" netlify netlify-honeypot="bot-field" name="event-segmentation-data-cn">
  <input type="hidden" name="form-name" value="event-segmentation-data-cn"> 
  <!-- 下面的字段会在 JS 里动态 append，这里留着占位也没关系 -->
  <input type="text" name="bot-field" style="display: none;">
</form>

<script>
// ====== 配置 ======
const TOTAL_VIDEOS = 10; 
const STORAGE_KEY_PROGRESS = 'seeg_cn_final_progress';
const STORAGE_KEY_NAME = 'seeg_cn_final_name';
const STORAGE_KEY_ALL_DATA = 'seeg_cn_final_alldata'; // 硬盘总账本

let currentIdx = 0; 
let currentEvents = []; // 当前视频的事件

// 页面加载：恢复名字
window.addEventListener('DOMContentLoaded', () => {
    const savedName = localStorage.getItem(STORAGE_KEY_NAME);
    if(savedName) {
        document.getElementById('participantName').value = savedName;
    }
});

// ====== 辅助函数：获取ID (防刷新丢失) ======
function getParticipantID() {
    let name = document.getElementById('participantName').value.trim();
    if(!name) name = localStorage.getItem(STORAGE_KEY_NAME) || "Unknown_User";
    return name;
}

// ====== 1. 同意书 ======
document.getElementById('agreeBtn').addEventListener('click', function() {
    const nameVal = document.getElementById('participantName').value.trim();
    if(!nameVal) { alert("请输入姓名"); return; }
    
    localStorage.setItem(STORAGE_KEY_NAME, nameVal);
    document.getElementById('consent').style.display = 'none';
    showStarterMenu();
});

// ====== 2. 菜单 ======
function showStarterMenu() {
    const starter = document.getElementById('starter');
    const select = document.getElementById('startSelect');
    select.innerHTML = '';
    
    const opt0 = document.createElement('option');
    opt0.value = 0; opt0.textContent = "0. 练习 (Practice)";
    select.appendChild(opt0);
    
    for(let i=1; i<=TOTAL_VIDEOS; i++){
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = `${i}. 视频 (Video ${i})`;
        select.appendChild(opt);
    }
    
    const savedIdx = localStorage.getItem(STORAGE_KEY_PROGRESS);
    if(savedIdx !== null) select.value = savedIdx;
    
    starter.style.display = 'flex';
}

document.getElementById('realStartBtn').addEventListener('click', function() {
    document.getElementById('starter').style.display = 'none';
    document.getElementById('experiment').style.display = 'block';
    initializeExperiment(parseInt(document.getElementById('startSelect').value));
});

// ====== 3. 实验逻辑 ======
function initializeExperiment(startAt) {
    currentIdx = startAt;
    let evtCnt = 0; 
    let fineTuning = false;
    let isTransitioning = false; 

    const v = document.getElementById('v');
    const prompt = document.getElementById('prompt');
    const counter = document.getElementById('counter');
    const descBox = document.getElementById('descBox');
    const descInput = document.getElementById('descInput');
    const evNumSpan = document.getElementById('evNum');
    const adjustHint = document.getElementById('adjustHint');

    loadNext();

    function loadNext(){
        isTransitioning = false;
        if(currentIdx > TOTAL_VIDEOS){ finishAll(); return; }

        localStorage.setItem(STORAGE_KEY_PROGRESS, currentIdx);

        if (currentIdx === 0) {
            v.src = 'practice.mp4';
            prompt.innerHTML = `<span style="color:#4CAF50; font-weight:bold;">[练习阶段]</span><br><br>准备好后，按任意键开始。`;
        } else {
            v.src = `v${currentIdx}.mp4`;
            prompt.innerHTML = `视频 ${currentIdx} / ${TOTAL_VIDEOS}<br>按任意键开始播放。`;
        }
        
        v.style.display = 'none';
        prompt.style.display = 'block';
        
        currentEvents = []; 
        evtCnt = 0;
        counter.textContent = '事件数: 0';
        fineTuning = false;
    }

    function pauseAndFineTune(){
        if(v.paused && fineTuning){
            fineTuning = false;
            adjustHint.style.display = 'none';
            v.play();
            return;
        }
        v.pause();
        fineTuning = true;
        adjustHint.style.display = 'block';
    }

    function confirmEnd(){
        fineTuning = false;
        adjustHint.style.display = 'none';
        currentEvents.push({vid: currentIdx, ev: evtCnt + 1, time: v.currentTime, desc: ''});
        evtCnt++;
        counter.textContent = '事件数: ' + evtCnt;
        descInput.value = '';
        evNumSpan.textContent = evtCnt;
        descBox.style.display = 'block';
        descInput.focus();
    }

    function saveDesc(){
        if(isTransitioning) return;
        const txt = descInput.value.trim();
        if(txt === '') { alert('请输入描述'); descInput.focus(); return; }
        
        const lastIdx = currentEvents.findIndex(o => o.vid === currentIdx && o.ev === evtCnt);
        if(lastIdx > -1) currentEvents[lastIdx].desc = txt;
        
        descBox.style.display = 'none';
        
        if(v.ended){
            isTransitioning = true;
            
            // === 核心：视频结束，保存并上传 ===
            saveAndUploadCurrentVideo(currentIdx, currentEvents);
            
            currentIdx++; 
            setTimeout(() => { loadNext(); }, 500); 
        } else {
            v.play();
        }
    }

    function cancelDescription() {
        descBox.style.display = 'none';
        const lastEventIndex = currentEvents.findIndex(o => o.vid === currentIdx && o.ev === evtCnt);
        if(lastEventIndex > -1) {
            currentEvents.splice(lastEventIndex, 1);
            evtCnt--;
            counter.textContent = '事件数: ' + evtCnt;
        }
        prompt.innerHTML = '已取消。<br>按任意键继续...';
        prompt.style.display = 'block';
        v.style.display = 'none';
    }

    function finishAll(){
        document.getElementById('experiment').style.display = 'none';
        document.getElementById('completion').style.display = 'flex';
        
        // === 核心：最后上传所有数据 ===
        uploadFinalSummary();

        localStorage.removeItem(STORAGE_KEY_PROGRESS);

        let timeLeft = 5;
        const timer = setInterval(() => {
            timeLeft--;
            document.getElementById('countdown').textContent = timeLeft;
            if(timeLeft <= 0) {
                clearInterval(timer);
                document.getElementById('waitMsg').style.display = 'none';
                document.getElementById('finalMsg').style.display = 'block';
            }
        }, 1000);
    }

    /* 键盘监听 */
    document.getElementById('okBtn').onclick = saveDesc;
    document.getElementById('cancelBtn').onclick = cancelDescription;
    document.onkeydown = (e) => {
        if(document.getElementById('experiment').style.display === 'none') return;
        if(document.activeElement.id === 'descInput') {
            if(e.code === 'Enter'){ e.preventDefault(); saveDesc(); }
            if(e.code === 'Escape') { e.preventDefault(); cancelDescription(); }
            return;
        }
        if(v.style.display === 'none' && prompt.style.display !== 'none' && e.target.tagName !== 'INPUT'){
            prompt.style.display = 'none'; v.style.display = 'block'; v.play(); return;
        }
        if(v.style.display !== 'none'){
            if(e.code === 'Space'){ e.preventDefault(); pauseAndFineTune(); return; }
            if(fineTuning && v.paused){
                if(e.code === 'ArrowLeft' || e.code === 'ArrowRight'){
                    e.preventDefault();
                    v.currentTime = Math.max(0, v.currentTime + (e.code==='ArrowLeft'?-1:1));
                    return;
                }
                if(e.code === 'Enter'){ e.preventDefault(); confirmEnd(); return; }
            }
        }
    };
    v.onended = () => {
        const finalTime = v.duration; 
        currentEvents.push({vid: currentIdx, ev: evtCnt + 1, time: finalTime, desc: '[auto-end]'});
        evtCnt++;
        counter.textContent = '事件数: ' + evtCnt;
        descInput.value = ''; evNumSpan.textContent = evtCnt;
        descBox.style.display = 'block'; descInput.focus();
    };
}

// ====== 4. 数据上传核心 (完全回归原始逻辑 + 硬盘备份) ======

// 辅助：从硬盘读取“总账本”
function getGlobalData() {
    try {
        const stored = localStorage.getItem(STORAGE_KEY_ALL_DATA);
        return stored ? JSON.parse(stored) : [];
    } catch (e) { return []; }
}

// 辅助：向硬盘追加数据
function appendToDisk(newEvents) {
    let all = getGlobalData();
    all = all.concat(newEvents);
    localStorage.setItem(STORAGE_KEY_ALL_DATA, JSON.stringify(all));
}

// (A) 单个视频做完：先存硬盘，再发 Netlify
async function saveAndUploadCurrentVideo(idx, events) {
    const vStr = (idx === 0) ? "practice" : idx.toString();
    
    // 1. 存硬盘 (防止刷新丢失)
    appendToDisk(events);
    
    // 2. 发 Netlify (单次)
    const pid = getParticipantID();
    const formData = new FormData(); // 手动构建，不依赖 form 元素，避免污染
    formData.append('form-name', 'event-segmentation-data-cn');
    formData.append('prolific_pid', pid);
    formData.append('study_id', 'chinese_exp_v1');
    formData.append('session_id', 'sess_' + pid);
    formData.append('video_index', vStr); // 标记：这是单个视频的数据
    formData.append('events', JSON.stringify(events));
    formData.append('completion_time', new Date().toISOString());
    formData.append('bot-field', ''); // honeypot

    try {
        await fetch('/', { method: 'POST', body: formData });
        console.log(`Uploaded video ${vStr}`);
    } catch (e) {
        console.error(`Upload failed for ${vStr}`);
    }
}

// (B) 全部做完：从硬盘读取所有数据，打包发 Netlify
async function uploadFinalSummary() {
    const allData = getGlobalData(); // 从硬盘读！确保包含之前的所有视频
    const pid = getParticipantID();

    const formData = new FormData();
    formData.append('form-name', 'event-segmentation-data-cn');
    formData.append('prolific_pid', pid);
    formData.append('study_id', 'chinese_exp_v1');
    formData.append('session_id', 'sess_' + pid);
    
    // 标记：这是最终汇总
    formData.append('video_index', 'ALL_SUMMARY_BACKUP'); 
    formData.append('events', JSON.stringify(allData));
    formData.append('completion_time', new Date().toISOString());
    formData.append('bot-field', '');

    try {
        await fetch('/', { method: 'POST', body: formData });
        console.log("Final summary uploaded.");
    } catch (e) {
        console.error("Final summary failed.");
    }
}
</script>
</body>
</html>
