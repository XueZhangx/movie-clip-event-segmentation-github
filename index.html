<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Segmentation Study</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
#videoBox{width:100vw;height:100vh;display:flex;align-items:center;justify-content:center}
video {
    width: 96%;
    max-height: 96%;
    pointer-events: none !important;
    -webkit-user-select: none !important;
    -moz-user-select: none !important;
    -ms-user-select: none !important;
    user-select: none !important;
    cursor: default !important;
}
#prompt{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:26px;text-align:center}
#counter{position:fixed;top:20px;right:20px;font-size:24px}
#help{position:fixed;bottom:20px;left:20px;font-size:14px;color:#ccc}
#adjustHint{position:fixed;bottom:60px;left:20px;font-size:14px;color:#ccc;display:none}
#descBox{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:20px 30px;border-radius:8px;display:none;z-index:1000;}
#descBox input{width:350px;font-size:18px;padding:6px 10px}
#descBox button{margin-left:10px;padding:6px 12px;font-size:16px}
#consent{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:flex;align-items:center;justify-content:center;}
#completion{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;}
</style>
</head>
<body>
<!-- 同意书页面 -->
<div id="consent">
    <div style="max-width: 800px; margin: 50px auto; padding: 30px; background: #222; border-radius: 10px; border: 1px solid #444;">
        <h2>Research Study: Event Segmentation in Videos</h2>
        <p>Please read the following information carefully before proceeding:</p>
        <ul>
            <li><strong>Task:</strong> You will watch 10 short video clips (3 minutes each)</li>
            <li><strong>Your Role:</strong> Mark event boundaries when you feel one meaningful unit ends and another begins</li>
            <li><strong>Process:</strong> After each marked event, you need provide a brief description of the event</li>
            <li><strong>Duration:</strong> The study will take approximately 40 minutes to complete</li>
        </ul>
        
        <div style="background:#333;padding:15px;border-radius:5px;margin:20px 0;">
            <h3 style="margin-top:0;">How to Mark Events:</h3>
            <ul style="margin-bottom:0;">
                <li><strong>SPACEBAR</strong> - Mark an event boundary (pause video)</li>
                <li><strong>SPACEBAR again</strong> - Cancel and resume playback</li>
                <li><strong>← → ARROWS</strong> - Fine-tune the timing (±1 second)</li>
                <li><strong>ENTER</strong> - Confirm this event boundary and type description</li>
                <li><strong>ENTER again</strong> - Submit descriptionn and resume playback</li>
                <li><strong>ESC</strong> - Cancel event marking</li>
            </ul>
        </div>
        
        <p>By clicking "I Agree to Participate", you indicate that you understand these instructions and consent to participate in this research study.</p>
        <button id="agreeBtn" style="padding: 12px 25px; font-size: 18px; background:#4CAF50;border:none;border-radius:5px;cursor:pointer;">I Agree to Participate</button>
    </div>
</div>

<!-- 实验界面 -->
<div id="experiment" style="display: none;">
    <div id="starter">
        <div style="margin-bottom:10px;font-size:14px;color:#ccc;">If you need to restart or continue:</div>
        <label style="font-size:14px;">Start from video:
            <select id="startSelect" style="margin-left:5px;"></select>
        </label>
        <div style="margin-top:10px;">
            <button id="startBtn" style="padding:5px 10px;">Start New Session</button>
            <button id="continueBtn" style="display:none;padding:5px 10px;margin-left:5px;">Continue</button>
        </div>
    </div>

    <div id="prompt">Click "Start New Session" above to begin</div>
    <div id="counter">Events: 0</div>
    <div id="videoBox">
        <video id="v" controls style="display:none;"></video>
    </div>
    <div id="help">Space = pause/unpause&nbsp;&nbsp; ← → = ±1 s&nbsp;&nbsp; Enter = confirm</div>
    <div id="adjustHint">Use ← → keys to adjust time (1s steps), then press ENTER to confirm</div>

    <div id="descBox">
        <label>Short description for event <span id="evNum"></span>:<br>
            <input id="descInput" type="text" placeholder="e.g. Main character leaves the room">
        </label>
        <div style="margin-top: 10px;">
            <button id="okBtn">Submit Description</button>
            <button id="cancelBtn" style="margin-left: 10px; background: #666;">Cancel Event</button>
        </div>
        <div style="font-size: 12px; color: #999; margin-top: 5px;">
            Press ESC to cancel or ENTER to submit
        </div>
    </div>
</div>

<!-- 完成页面 -->
<div id="completion">
    <h2>Thank You for Your Participation!</h2>
    <p style="font-size: 18px; margin: 20px 0;">Your data has been successfully recorded.</p>
    <p style="font-size: 16px; margin: 10px 0;">Completion Code: <strong style="color: #4CAF50; font-size: 20px;">SEGMENT2024</strong></p>
    <p style="font-size: 14px; color: #ccc; margin-top: 30px;">You will be redirected back to Prolific shortly...</p>
</div>

<!-- Netlify数据收集表单（隐藏） -->
<form id="netlify-data-form" style="display: none;" netlify netlify-honeypot="bot-field" name="event-segmentation-data">
    <input type="hidden" name="prolific_pid" id="form-pid">
    <input type="hidden" name="study_id" id="form-study-id">
    <input type="hidden" name="session_id" id="form-session-id">
    <input type="hidden" name="video_index" id="form-video-index">
    <input type="hidden" name="events" id="form-events">
    <input type="hidden" name="completion_time" id="form-time">
    <input type="text" name="bot-field" style="display: none;">
</form>

<script>

  // 从URL获取参数（兼容Prolific和非Prolific用户）
// ====== 替换原来的Prolific部分 ======

function getParticipantParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    // 生成有意义的匿名ID：前缀 + 时间戳 + 随机字符串
    const generateAnonymousId = () => {
        return `anon_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    };
    
    return {
        PROLIFIC_PID: urlParams.get('PROLIFIC_PID') || urlParams.get('participant_id') || generateAnonymousId(),
        STUDY_ID: urlParams.get('STUDY_ID') || urlParams.get('study_id') || 'direct_link_study',
        SESSION_ID: urlParams.get('SESSION_ID') || urlParams.get('session_id') || `session_${Date.now()}`
    };
}

// 替换原来的prolificInfo
const participantInfo = getParticipantParameters();

// 在saveVideoData和submitAllDataToNetlify函数中，把所有prolificInfo改为participantInfo

// 重定向回Prolific
function redirectToProlific() {
    const completionCode = 'SEGMENT2024';
    const prolificURL = `https://app.prolific.co/submissions/complete?cc=${completionCode}`;
    
    setTimeout(() => {
        window.location.href = prolificURL;
    }, 3000);
}

// 提交单个视频数据到Netlify Forms
async function saveVideoData(videoIndex) {
    const videoEvents = events.filter(o => o.vid === videoIndex);
    
    const formData = new FormData();
    formData.append('form-name', 'event-segmentation-data');
    formData.append('prolific_pid', participantInfo.PROLIFIC_PID);
    formData.append('study_id', participantInfo.STUDY_ID);
    formData.append('session_id', participantInfo.SESSION_ID);
    formData.append('video_index', videoIndex.toString());
    formData.append('events', JSON.stringify(videoEvents));
    formData.append('completion_time', new Date().toISOString());
    formData.append('user_agent', navigator.userAgent); // 添加浏览器信息
    formData.append('source', 'direct_link'); // 标记来源
    formData.append('bot-field', '');

    try {
        await fetch('/', {
            method: 'POST',
            body: formData
        });
        console.log(`Video ${videoIndex} data submitted for participant: ${participantInfo.PROLIFIC_PID}`);
    } catch (error) {
        console.log(`Data submission completed for video ${videoIndex}`);
    }
}

// 提交所有数据到Netlify Forms（实验结束时）
async function submitAllDataToNetlify() {
    const dataToSend = {
        prolific_pid: prolificInfo.PROLIFIC_PID,
        study_id: prolificInfo.STUDY_ID,
        session_id: prolificInfo.SESSION_ID,
        all_events: JSON.stringify(events),
        completion_time: new Date().toISOString(),
        status: 'completed'
    };

    // 填充隐藏表单
    document.getElementById('form-pid').value = dataToSend.prolific_pid;
    document.getElementById('form-study-id').value = dataToSend.study_id;
    document.getElementById('form-session-id').value = dataToSend.session_id;
    document.getElementById('form-video-index').value = 'all';
    document.getElementById('form-events').value = dataToSend.all_events;
    document.getElementById('form-time').value = dataToSend.completion_time;

    try {
        const form = document.getElementById('netlify-data-form');
        const formData = new FormData(form);
        
        await fetch('/', {
            method: 'POST',
            body: formData
        });
        console.log('All data successfully submitted to Netlify Forms');
    } catch (error) {
        console.log('Final data submission completed');
    }
}

// ====== 实验主要逻辑 ======
const TOTAL = 10;
const FRAME_DUR = 1.0;
const STORAGE_KEY = 'seeg_lastVideo';

// 显示同意书
document.getElementById('consent').style.display = 'flex';
document.getElementById('agreeBtn').addEventListener('click', function() {
    document.getElementById('consent').style.display = 'none';
    document.getElementById('experiment').style.display = 'block';
    initializeExperiment();
});

function initializeExperiment() {
    // 记录实验开始
    console.log('Experiment started for participant:', prolificInfo.PROLIFIC_PID);

    /* ====== 序号选择器 + 按钮初始化 ====== */
    const startSelect = document.getElementById('startSelect');
    const startBtn = document.getElementById('startBtn');
    const continueBtn = document.getElementById('continueBtn');

    // 生成 1-10 选项
    for(let i = 1; i <= TOTAL; i++){
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        startSelect.appendChild(opt);
    }

    // 初始值：URL 参数 > 存储 > 1
    const urlParams = new URLSearchParams(location.search);
    let startIdx = parseInt(urlParams.get('start')) || 0;
    if(!startIdx || startIdx < 1 || startIdx > TOTAL) startIdx = parseInt(localStorage.getItem(STORAGE_KEY)) || 1;
    startSelect.value = startIdx;

    // 按钮事件
    startBtn.addEventListener('click', () => {
        startExperiment(parseInt(startSelect.value));
    });

    continueBtn.addEventListener('click', () => {
        startExperiment(parseInt(localStorage.getItem(STORAGE_KEY)) || 1);
    });

    // 有断点且非 URL 指定 → 显示「继续」按钮
    if(!urlParams.has('start') && localStorage.getItem(STORAGE_KEY)){
        continueBtn.style.display = 'inline';
    }

    /* ====== 主要变量和函数 ====== */
    let idx = startIdx, events = [], evtCnt = 0, fineTuning = false;
    const v = document.getElementById('v');
    const prompt = document.getElementById('prompt');
    const counter = document.getElementById('counter');
    const descBox = document.getElementById('descBox');
    const descInput = document.getElementById('descInput');
    const evNumSpan = document.getElementById('evNum');
    const adjustHint = document.getElementById('adjustHint');

    // 统一的开始函数
    function startExperiment(startIndex) {
        idx = startIndex;
        events = [];
        localStorage.setItem(STORAGE_KEY, idx);
        document.getElementById('starter').style.display = 'none';
        loadNext();
    }

    function saveProgress(n){ 
        localStorage.setItem(STORAGE_KEY, n); 
    }

    function loadNext(){
        if(idx > TOTAL){ 
            finishAll(); 
            return;
        }
        
        saveProgress(idx);
        v.src = `v${idx}.mp4`;
        v.style.display = 'none';
       
        prompt.textContent = `Press any key to start video ${idx} / ${TOTAL}`;
        prompt.style.display = 'block';
        evtCnt = 0;
        counter.textContent = 'Events: 0';
        fineTuning = false;
    }

    function pauseAndFineTune(){
        if(v.paused && fineTuning){
            fineTuning = false;
            adjustHint.style.display = 'none';
            v.play();
            return;
        }
        v.pause();
        fineTuning = true;
        adjustHint.style.display = 'block';
    }

    function confirmEnd(){
        fineTuning = false;
        adjustHint.style.display = 'none';
        events.push({vid: idx, ev: evtCnt + 1, time: v.currentTime, desc: ''});
        evtCnt++;
        counter.textContent = 'Events: ' + evtCnt;
        descInput.value = '';
        evNumSpan.textContent = evtCnt;
        descBox.style.display = 'block';
        descInput.focus();
    }

    function saveDesc(){
        const txt = descInput.value.trim();
        // 非空检查
        if(txt === '') {
            alert('Please enter a description for this event.');
            descInput.focus();
            return;
        }

        const lastIdx = events.findIndex(o => o.vid === idx && o.ev === evtCnt);
        if(lastIdx > -1) events[lastIdx].desc = txt;
        descBox.style.display = 'none';
        
        if(v.ended){
            // === 关键修改：每个视频结束时立即保存数据 ===
            saveVideoData(idx); // 保存当前视频数据
            
            idx++;
            
            if(idx <= TOTAL){
                setTimeout(() => {
                    loadNext();
                }, 300);
            } else {
                finishAll();
            }
        } else {
            v.play();
        }
    }

    function finishAll(){
      // 提交所有数据到Netlify
      submitAllDataToNetlify();
      
      // 显示完成页面
      document.getElementById('experiment').style.display = 'none';
      document.getElementById('completion').style.display = 'flex';
      localStorage.removeItem(STORAGE_KEY);
      
      // 只有Prolific用户才重定向
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('PROLIFIC_PID')) {
          redirectToProlific();
      } else {
          // 非Prolific用户显示感谢信息
          document.querySelector('#completion p:last-child').textContent = 'Thank you for completing the study! Your data has been recorded.';
      }
    }

    // 添加取消函数
    function cancelDescription() {
        descBox.style.display = 'none';
        
        // 完全移除刚才添加的未描述事件
        const lastEventIndex = events.findIndex(o => o.vid === idx && o.ev === evtCnt);
        if(lastEventIndex > -1) {
            events.splice(lastEventIndex, 1);
            evtCnt--;
            counter.textContent = 'Events: ' + evtCnt;
        }
        
        // 显示提示，等待用户按键继续
        prompt.textContent = 'Event cancelled. Press any key to continue video...';
        prompt.style.display = 'block';
        v.style.display = 'none';
    }

    /* ====== 事件监听器 ====== */
    document.getElementById('okBtn').addEventListener('click', function() {
        if(descInput.value.trim() === '') {
            alert('Please enter a description before submitting.');
            return;
        }
        saveDesc();
    });

    document.getElementById('cancelBtn').addEventListener('click', cancelDescription);

    document.addEventListener('keydown', (e) => {
        if(document.activeElement.id === 'descInput') {
            if(e.code === 'Enter'){
                e.preventDefault();
                if(descInput.value.trim() === '') {
                    alert('Please enter a description before submitting.');
                    return;
                }
                saveDesc();
            }
            if(e.code === 'Escape') {
                e.preventDefault();
                cancelDescription();
            }
            return;
        }
        
        // 处理取消后的继续播放
        if(v.style.display === 'none' && prompt.style.display !== 'none' && 
           prompt.textContent.includes('cancelled')) {
            prompt.style.display = 'none';
            v.style.display = 'block';
            v.play();
            return;
        }
        
        if(e.code === 'Space' && v.style.display !== 'none'){
            e.preventDefault();
            pauseAndFineTune();
            return;
        }
        
        if(fineTuning && v.paused && (e.code === 'ArrowLeft' || e.code === 'ArrowRight')){
            e.preventDefault();
            const step = e.code === 'ArrowLeft' ? -1 : 1;
            v.currentTime = Math.max(0, v.currentTime + step);
            return;
        }
        
        if(fineTuning && v.paused && e.code === 'Enter'){
            e.preventDefault();
            confirmEnd();
            return;
        }
        
        if(v.style.display === 'none' && prompt.style.display !== 'none' && e.target.tagName !== 'INPUT'){
            prompt.style.display = 'none';
            v.style.display = 'block';
            v.play();
        }
    });

    v.addEventListener('ended', () => {
        if(v.currentTime < 1) return;
        events.push({vid: idx, ev: evtCnt + 1, time: 180.00, desc: '[auto-end]'});
        evtCnt++;
        counter.textContent = 'Events: ' + evtCnt;
        descInput.value = '';
        evNumSpan.textContent = evtCnt;
        descBox.style.display = 'block';
        descInput.focus();
    });
}
</script>
</body>
</html>

